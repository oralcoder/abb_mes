{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - MES{% endblock %}

{% block content %}
<div class="container-fluid">
  <h2 class="mb-4">ğŸ“Š ìƒì‚° ëŒ€ì‹œë³´ë“œ</h2>
  
  <!-- KPI ì¹´ë“œ -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center border-primary">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">ì´ ì‘ì—…ì§€ì‹œ</h6>
          <h2 class="card-title text-primary">{{ kpi.total_orders }}</h2>
          <small class="text-muted">ê±´</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center border-success">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">ì™„ë£Œ</h6>
          <h2 class="card-title text-success">{{ kpi.completed_orders }}</h2>
          <small class="text-muted">{{ kpi.completion_rate }}%</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center border-warning">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">ì§„í–‰ì¤‘</h6>
          <h2 class="card-title text-warning">{{ kpi.in_progress }}</h2>
          <small class="text-muted">ê±´</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center border-info">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">í‰ê·  í¸ì°¨ìœ¨</h6>
          <h2 class="card-title text-info">{{ kpi.avg_deviation_rate }}%</h2>
          <small class="text-muted">í‘œì¤€ì‹œê°„ ëŒ€ë¹„</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center border-info">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">ì˜ˆì¸¡ ìƒì‚°ëŸ‰</h6>
          <h2 class="card-title text-info">{{ prediction.predicted_production_qty }}</h2>
          <small class="text-muted">{{ prediction.target_date }}</small>
        </div>
      </div>
    </div>
  </div>

  <!-- ì°¨íŠ¸ í–‰ 1 -->
  <div class="row mb-4">
    <!-- ì œí’ˆë³„ ìƒì‚° í˜„í™© -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">ğŸ“¦ ì œí’ˆë³„ ì‘ì—…ì§€ì‹œ ê±´ìˆ˜</h5>
        </div>
        <div class="card-body">
          <canvas id="productChart" height="250"></canvas>
        </div>
      </div>
    </div>

    <!-- ìƒíƒœë³„ ë¶„í¬ -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">ğŸ“‹ ì‘ì—…ì§€ì‹œ ìƒíƒœ ë¶„í¬</h5>
        </div>
        <div class="card-body">
          <canvas id="statusChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ì°¨íŠ¸ í–‰ 2 -->
  <div class="row mb-4">
    <!-- ê³µì •ë³„ í‰ê·  ì‘ì—…ì‹œê°„ -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">âš™ï¸ ê³µì •ë³„ í‰ê·  ì‘ì—…ì‹œê°„</h5>
        </div>
        <div class="card-body">
          <canvas id="operationChart" height="250"></canvas>
        </div>
      </div>
    </div>

    <!-- ì„¤ë¹„ë³„ ê°€ë™ í˜„í™© -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">ğŸ­ ì„¤ë¹„ë³„ ì‘ì—… ê±´ìˆ˜ (Top 10)</h5>
        </div>
        <div class="card-body">
          <canvas id="equipmentChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ì°¨íŠ¸ í–‰ 3 -->
  <div class="row mb-4">
    <!-- ì¼ë³„ ìƒì‚°ëŸ‰ ì¶”ì´ -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">ğŸ“ˆ ì¼ë³„ ìƒì‚°ëŸ‰ ì¶”ì´ (ìµœê·¼ 30ì¼)</h5>
        </div>
        <div class="card-body">
          <canvas id="dailyChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- í¸ì°¨ìœ¨ ë¶„í¬ -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">ğŸ“Š ì‘ì—…ì‹œê°„ í¸ì°¨ìœ¨ ë¶„í¬</h5>
        </div>
        <div class="card-body">
          <canvas id="deviationChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
  <div class="row mb-4">
    <div class="col-12 text-center">
      <button class="btn btn-primary btn-lg" onclick="location.reload()">
        ğŸ”„ ìƒˆë¡œê³ ì¹¨
      </button>
    </div>
  </div>

</div>

<!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ì°¨íŠ¸ ê³µí†µ ì˜µì…˜
const commonOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: {
    legend: {
      display: true,
      position: 'top',
    }
  }
};

// 1. ì œí’ˆë³„ ì‘ì—…ì§€ì‹œ ê±´ìˆ˜ (ë§‰ëŒ€ ì°¨íŠ¸)
const productCtx = document.getElementById('productChart').getContext('2d');
new Chart(productCtx, {
  type: 'bar',
  data: {
    labels: {{ product_chart.labels | tojson }},
    datasets: [{
      label: 'ì‘ì—…ì§€ì‹œ ê±´ìˆ˜',
      data: {{ product_chart.data | tojson }},
      backgroundColor: 'rgba(54, 162, 235, 0.6)',
      borderColor: 'rgba(54, 162, 235, 1)',
      borderWidth: 1
    }]
  },
  options: {
    ...commonOptions,
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 10
        }
      }
    }
  }
});

// 2. ìƒíƒœë³„ ë¶„í¬ (ë„ë„› ì°¨íŠ¸)
const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
  type: 'doughnut',
  data: {
    labels: {{ status_chart.labels | tojson }},
    datasets: [{
      label: 'ì‘ì—…ì§€ì‹œ ê±´ìˆ˜',
      data: {{ status_chart.data | tojson }},
      backgroundColor: [
        'rgba(255, 99, 132, 0.6)',
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(153, 102, 255, 0.6)',
        'rgba(255, 159, 64, 0.6)'
      ],
      borderWidth: 1
    }]
  },
  options: {
    ...commonOptions,
  }
});

// 3. ê³µì •ë³„ í‰ê·  ì‘ì—…ì‹œê°„ (ìˆ˜í‰ ë§‰ëŒ€ ì°¨íŠ¸)
const operationCtx = document.getElementById('operationChart').getContext('2d');
new Chart(operationCtx, {
  type: 'bar',
  data: {
    labels: {{ operation_chart.labels | tojson }},
    datasets: [{
      label: 'í‰ê·  ì‘ì—…ì‹œê°„ (ë¶„)',
      data: {{ operation_chart.data | tojson }},
      backgroundColor: 'rgba(255, 206, 86, 0.6)',
      borderColor: 'rgba(255, 206, 86, 1)',
      borderWidth: 1
    }]
  },
  options: {
    ...commonOptions,
    indexAxis: 'y',
    scales: {
      x: {
        beginAtZero: true
      }
    }
  }
});

// 4. ì„¤ë¹„ë³„ ì‘ì—… ê±´ìˆ˜ (ìˆ˜í‰ ë§‰ëŒ€ ì°¨íŠ¸)
const equipmentCtx = document.getElementById('equipmentChart').getContext('2d');
new Chart(equipmentCtx, {
  type: 'bar',
  data: {
    labels: {{ equipment_chart.labels | tojson }},
    datasets: [{
      label: 'ì‘ì—… ê±´ìˆ˜',
      data: {{ equipment_chart.data | tojson }},
      backgroundColor: 'rgba(75, 192, 192, 0.6)',
      borderColor: 'rgba(75, 192, 192, 1)',
      borderWidth: 1
    }]
  },
  options: {
    ...commonOptions,
    indexAxis: 'y',
    scales: {
      x: {
        beginAtZero: true
      }
    }
  }
});

// 5. ì¼ë³„ ìƒì‚°ëŸ‰ ì¶”ì´ (ì„  ì°¨íŠ¸)
const dailyCtx = document.getElementById('dailyChart').getContext('2d');
new Chart(dailyCtx, {
  type: 'line',
  data: {
    labels: {{ daily_chart.labels | tojson }},
    datasets: [{
      label: 'ìƒì‚°ëŸ‰ (ê°œ)',
      data: {{ daily_chart.data | tojson }},
      backgroundColor: 'rgba(153, 102, 255, 0.2)',
      borderColor: 'rgba(153, 102, 255, 1)',
      borderWidth: 2,
      fill: true,
      tension: 0.4
    }]
  },
  options: {
    ...commonOptions,
    scales: {
      y: {
        beginAtZero: true
      }
    }
  }
});

// 6. í¸ì°¨ìœ¨ ë¶„í¬ (ë§‰ëŒ€ ì°¨íŠ¸)
const deviationCtx = document.getElementById('deviationChart').getContext('2d');
new Chart(deviationCtx, {
  type: 'bar',
  data: {
    labels: {{ deviation_chart.labels | tojson }},
    datasets: [{
      label: 'ë¹ˆë„',
      data: {{ deviation_chart.data | tojson }},
      backgroundColor: 'rgba(255, 99, 132, 0.6)',
      borderColor: 'rgba(255, 99, 132, 1)',
      borderWidth: 1
    }]
  },
  options: {
    ...commonOptions,
    scales: {
      y: {
        beginAtZero: true
      }
    },
    plugins: {
      legend: {
        display: false
      }
    }
  }
});
</script>

{% endblock %}
